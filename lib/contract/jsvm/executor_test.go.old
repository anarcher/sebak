package jsvm

import (
	"testing"

	sebak "boscoin.io/sebak/lib"
	"boscoin.io/sebak/lib/contract/payload"
	"github.com/stretchr/testify/assert"
)

func Test_JSVM_Executor(t *testing.T) {
	testAddress := "testadress"
	testCode := `
function Hello(helloarg){
    return HelloWorld(helloarg)
}
`

	st, err := sebakstorage.NewTestMemoryLevelDBBackend()
	if err != nil {
		t.Fatal(err)
	}

	store := sebak.NewStateStore(st)
	clone := sebak.NewStateClone(store)

	deployCode := &payload.DeployCode{
		ContractAddress: testAddress,
		Code:            []byte(testCode),
		Type:            payload.JavaScript,
	}

	ctx := &sebak.ContractContext{
		StateStore: store,
		StateClone: clone,
	}

	api := sebak.NewContractAPI(ctx, testAddress)
	ex := NewOttoExecutor(ctx, api, deployCode)
	excode := &payload.ExecCode{
		ContractAddress: testAddress,
		Method:          "Hello",
		Args:            []string{"boscoin"},
	}

	ret, err := ex.Execute(excode)
	if err != nil {
		t.Fatal(err)
	}
	want, err := api.Helloworld("boscoin")
	if err != nil {
		t.Fatal(err)
	}

	assert.Equal(t, string(ret.Contents), want)
	t.Log(string(ret.Contents))
}
